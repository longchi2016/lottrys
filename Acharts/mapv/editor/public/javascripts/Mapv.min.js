!function(){function Class(){this.__listeners={}}function DataRange(a){Class.call(this),this.initOptions({min:0,max:0}),this.set("layer",a),this.bindTo("data",a),this.bindTo("drawOptions",a),this.bindTo("drawType",a)}function SizeDataRange(){DataRange.call(this)}function Mapv(a){Class.call(this),this.initOptions($.extend({map:null,drawTypeControl:!1,drawTypeControlOptions:{a:1}},a)),this._layers=[],this._initDrawScale(),this.notify("drawTypeControl")}function CanvasLayer(a){this.options=a||{},this.paneName=this.options.paneName||"labelPane",this.zIndex=this.options.zIndex||0,this._map=a.map,this.show()}function Layer(a){Class.call(this),this._drawer={},this.initOptions($.extend({ctx:null,animationCtx:null,mapv:null,paneName:"labelPane",map:null,context:"2d",data:[],dataType:"point",animationOptions:{size:5},coordType:"bd09ll",drawType:"simple",animation:!1,geometry:null,dataRangeControl:!0,zIndex:1},a)),this.dataRangeControl=new DataRangeControl,this.notify("data"),this.notify("mapv")}function DataControl(a){this.initDom(),this.initEvent(),this["super"]=a,this.geoData=a.geoData}function DataRangeControl(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function DrawScale(){this.init(),this._Event()}function drawTips(a){var b=a.left,c=a.right,d=a.top,e=a.ctx;e.beginPath(),e.moveTo(b+8,d-7),e.lineTo(c,d-7),e.lineTo(c,d+7),e.lineTo(b+8,d+7),e.lineTo(b,d),e.fill();var f=e.isPointInPath(a.sup.point.x,a.sup.point.y);f&&(a.sup.hoveredHandle=a),e.save(),e.fillStyle="white",e.fillText(a.text,b+8,d),e.restore()}function DrawTypeControl(a){Class.call(this),a=a||{},this.initOptions($.extend({mapv:null,drawTypeControlOptions:{},layer:null},a)),this.bindTo("drawTypeControlOptions",this.getMapv()),this.mapv=a.mapv,this.defaultAnchor=this.getDrawTypeControlOptions().anchor||BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=this.getDrawTypeControlOptions().offset||new BMap.Size(10,10)}function OptionalData(a){var b=a.options||{};this.drawType=b.drawType,this["super"]=a,this.options=b.drawOptions||{},this.initCSS(),this.initDom(),this.bindEvent()}function Drawer(a){Class.call(this),this.mapv=a._mapv,this.initOptions({layer:a,map:a.getMap(),ctx:null,mapv:null,animationOptions:{},drawOptions:{size:2}}),this.dataRange=new DataRange(a),this.bindTo("ctx",a),this.bindTo("animationOptions",a),this.bindTo("drawOptions",a),this.bindTo("mapv",a),this.bindTo("map",a)}function BubbleDrawer(){Drawer.apply(this,arguments)}function CategoryDrawer(){Drawer.apply(this,arguments)}function ChoroplethDrawer(){Drawer.apply(this,arguments)}function ClusterDrawer(){Drawer.apply(this,arguments)}function DensityDrawer(){this.Scale,this.masker={},Drawer.apply(this,arguments)}function recGrids(a,b){for(var c,d,e=a.data,f=a.nwMc,g=a.size,h=a.zoomUnit,i={},j=g/h,k=parseInt(f.x/g,10)*g,l=(k-f.x)/h,m=[],n=0;l+n*j<b.getSize().width;){var o=l+n*j;m.push(o.toFixed(2)),n++}for(var p=parseInt(f.y/g,10)*g+g,q=(f.y-p)/h,r=[],s=0;q+s*j<b.getSize().height;)o=q+s*j,r.push(o.toFixed(2)),s++;for(var t=0;t<m.length;t++)for(var u=0;u<r.length;u++){var v=m[t]+"_"+r[u];i[v]=0}for(var t=0;t<e.length;t++){var w=e[t].px,x=e[t].py,y=parseInt(e[t].count,10),z=w<m[0],A=x<r[0],B=w>Number(m[m.length-1])+Number(j),C=x>Number(r[r.length-1])+Number(j);if(!(z||A||B||C)){for(var u=0;u<m.length;u++){var D=Number(m[u]);if(w>=D&&D+j>w)for(var E=0;E<r.length;E++){var F=Number(r[E]);x>=F&&F+j>x&&(i[m[u]+"_"+r[E]]+=y,y=i[m[u]+"_"+r[E]])}}d=d||y,c=c||y,d=d>y?y:d,c=y>c?y:c}}return{grids:i,max:c,min:d}}function drawRec(a){var b=a.size,c=a.zoomUnit,d=a.max,e=a.min,f=a.ctx,g=a.grids,h=(a.fillColors,a.sup),i=b/c,j=(d-e+1)/10;for(var k in g){var l=k.split("_"),m=l[0],n=l[1],o=((g[k]-e)/j,a.dataRange.getColorByGradient(g[k])),p=h.masker.min&&g[k]<h.masker.min,q=h.masker.max&&g[k]>h.masker.max;0===g[k]||p||q?f.fillStyle="rgba(255,255,255,0.1)":f.fillStyle=o,f.fillRect(m,n,i-1,i-1),h.getDrawOptions().label&&h.getDrawOptions().label.show&&(f.save(),f.textBaseline="top",0===g[k]||p||q||(f.fillStyle="rgba(0,0,0,0.8)",f.fillText(g[k],m,n)),f.restore())}}function honeycombGrid(a){var b,c,d=a.data,e=a.nwMc,f=a.size,g=a.zoomUnit,h=a.ctx,i={},j=f/g,k=j,l=3*j/4,m=2*f*3/4,n=parseInt(e.y/m+1,10)*m,o=(e.y-n)/g;o=parseInt(o,10);var p=k*f,q=parseInt(e.x/p,10)*p,r=(q-e.x)/g;r=parseInt(r,10);for(var s=parseInt(h.canvas.width+p/g,10),t=parseInt(h.canvas.height+m/g,10),u=r,v=o,w=!1;t>v;){for(;s>u;){var x=w?u-k/2:u;x=parseInt(x,10),i[x+"|"+v]=i[x+"|"+v]||{x:x,y:v,len:0},u+=k}w=!w,u=r,v+=l}for(var y in d){var z=d[y].count,A=d[y].px,B=d[y].py,C=Math.round((B-o)/l),D=C*l+o,E=Math.round((A-r)/k),F=E*k+r;if(C%2&&(F-=k/2),!(r>F||F>s||o>D||D>t)&&i[F+"|"+D]){i[F+"|"+D].len+=z;var G=i[F+"|"+D].len;b=b||G,c=c||G,b=Math.max(b,G),c=Math.min(c,G)}}return{grids:i,max:b,min:c}}function drawHoneycomb(a){var b=a.ctx,c=a.grids,d=a.size/a.zoomUnit,e=a.fillColors,f=(a.max-a.min-1)/e.length;for(var g in c){var h=c[g].x,i=c[g].y,j=c[g].len,k=j/f|0;k=k>=e.length?e.length-1:k,k=0>k?0:k;var l=a.dataRange.getColorByGradient(j),m=a.sup.masker.min&&a.sup.masker.min>j,n=a.sup.masker.max&&a.sup.masker.max<j;j>0&&!m&&!n?draw(h,i,d-1,l,b):draw(h,i,d-1,"rgba(0,0,0,0.4)",b),a.sup.getDrawOptions().label&&a.sup.getDrawOptions().label&&!m&&!n&&(b.save(),b.textBaseline="middle",b.textAlign="center",b.fillStyle="rgba(0,0,0,0.8)",b.fillText(j,h,i),b.restore())}}function draw(a,b,c,d,e){e.beginPath(),e.fillStyle=d,e.moveTo(a,b-c/2),e.lineTo(a+c/2,b-c/4),e.lineTo(a+c/2,b+c/4),e.lineTo(a,b+c/2),e.lineTo(a-c/2,b+c/4),e.lineTo(a-c/2,b-c/4),e.fill(),e.closePath()}function formatParam(){var a=this.getDrawOptions(),b=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]],c=a.size||"50";return c+=a.unit||"px",c=/px$/.test(c)?parseInt(c,10)*this.zoomUnit:parseInt(c,10),{size:c,colors:b}}function HeatmapDrawer(){var a=this;a.masker={},Drawer.apply(this,arguments),this._max=20,this._data=[]}function IntensityDrawer(){this.masker={min:0,max:0},Drawer.apply(this,arguments),this._tmpCanvas=document.createElement("canvas")}function SimpleDrawer(){Drawer.apply(this,arguments)}var Mapv,util={isPlainObject:function(a){var b,c={},d=c.hasOwnProperty;if(!a||"object"!=typeof a||a.nodeType)return!1;var e=!d.call(a,"constructor"),f=!d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&e&&f)return!1;for(b in a);return void 0===b||d.call(a,b)},extend:function(a,b){var c,d=Object.prototype.toString,e="[object Array]";a=a||{};for(c in b)b.hasOwnProperty(c)&&(util.isPlainObject(b[c])?(a[c]=d.call(b[c])===e?[]:{},arguments.callee(a[c],b[c]),a[c]=b[c]):a[c]=b[c]);return a},copy:function(a){return this.extend({},a)},inherits:function(a,b){var c,d,e=a.prototype,f=new Function;f.prototype=b.prototype,d=a.prototype=new f;for(c in e)d[c]=e[c];a.prototype.constructor=a,a.superClass=b.prototype},addCssByStyle:function(a){var b=document,c=b.createElement("style");if(c.setAttribute("type","text/css"),c.styleSheet)c.styleSheet.cssText=a;else{var d=b.createTextNode(a);c.appendChild(d)}var e=b.getElementsByTagName("head");e.length?e[0].appendChild(c):b.documentElement.appendChild(c)},getGeoCenter:function(a){for(var b=a[0][0],c=a[0][1],d=a[0][0],e=a[0][1],f=1;f<a.length;f++)b=Math.min(b,a[f][0]),d=Math.max(d,a[f][0]),c=Math.min(c,a[f][1]),e=Math.max(e,a[f][1]);return[b+(d-b)/2,c+(e-c)/2]}},MVCObject;!function(){function a(a,b){var c=this;c.target=a,c.targetKey=b}a.prototype.transform=function(a,b){var c=this;return c.from=a,c.to=b,c.target.notify(c.targetKey),c},MVCObject=function(){function b(a){return a.substr(0,1).toUpperCase()+a.substr(1)}function c(a){return a[n]||(a[n]=++k)}function d(a){return"_"+a}function e(a){return i.hasOwnProperty(a)?i[a]:i[a]="get"+b(a)}function f(a){return j.hasOwnProperty(a)?j[a]:j[a]="set"+b(a)}function g(a,b){var c=b+"_changed";if(a[c]?a[c]():"function"==typeof a.changed&&a.changed(b),a[l]&&a[l][b]){var d,e,f=a[l][b];for(e in f)f.hasOwnProperty(e)&&(d=f[e],g(d.target,d.targetKey))}}function h(){}var i={},j={},k=0,l="__bindings__",m="__accessors__",n="__uid__",o=h.prototype;return o.get=function(a){var b=this;if(b[m]&&b[m].hasOwnProperty(a)){var c,f=b[m][a],g=f.targetKey,h=f.target,i=e(g);c=h[i]?h[i]():h.get(g),f.to&&(c=f.to(c))}else b.hasOwnProperty(d(a))&&(c=b[d(a)]);return c},o.set=function(a,b){var c=this;if(c[m]&&c[m].hasOwnProperty(a)){var e=c[m][a],h=e.targetKey,i=e.target,j=f(h);e.from&&(b=e.from(b)),i[j]?i[j](b):i.set(h,b)}else this[d(a)]=b,g(c,a);return c},o.changed=function(){},o.notify=function(a){var b=this;if(b[m]&&b[m].hasOwnProperty(a)){var c=b[m][a],d=c.targetKey,e=c.target;e.notify(d)}else g(b,a);return b},o.setValues=function(a){var b,c,d,e=this;for(b in a)a.hasOwnProperty(b)&&(d=a[b],c=f(b),e[c]?e[c](d):e.set(b,d));return e},o.setOptions=o.setValues,o.bindTo=function(b,d,e,f){e||(e=b);var h=this;h.unbind(b),h[m]||(h[m]={}),d[l]||(d[l]={}),d[l][e]||(d[l][e]={});var i=new a(h,b),j=new a(d,e);return h[m][b]=j,d[l][e][c(h)]=i,f||g(h,b),j},o.unbind=function(a){var b=this;if(b[m]){var e=b[m][a];if(e){var f=e.target,g=e.targetKey;b[d(a)]=b.get(a),delete f[l][g][c(b)],delete b[m][a]}}return b},o.unbindAll=function(){var a=this;if(a[m]){var b=a[m];for(var c in b)b.hasOwnProperty(c)&&a.unbind(c)}return a},o.initOptions=function(a){for(var b in a)this[e(b)]=function(a){return function(){return this.get(a)}}(b),this[f(b)]=function(a){return function(b){this.set(a,b)}}(b),this[d(b)]=a[b]},h}()}(),Mapv.MVCObject=MVCObject,util.inherits(Class,MVCObject),Class.prototype.addEventListener=function(a,b){return"object"!=typeof this.__listeners[a]&&(this.__listeners[a]=[]),this.__listeners[a].push(b),this},Class.prototype.removeEventListener=function(a,b){var c=this.__listeners[a];if(!c)return!1;for(var d=c.length;d>=0;d--)c[d]===b&&c.splice(d,1);return this},Class.prototype.dispatchEvent=function(a,b){var c=util.extend({},b),d=this.__listeners[a];if(!d)return!1;for(var e=d.length-1;e>=0;e--)d[e].call(this,c);return this},Class.prototype.dispose=function(){},util.inherits(DataRange,Class),util.extend(DataRange.prototype,{defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},colors:["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],getSize:function(a){for(var b=1,c=this.splitList,d=0;d<c.length;d++)if((void 0===c[d].start||void 0!==c[d].start&&a>=c[d].start)&&(void 0===c[d].end||void 0!==c[d].end&&a<c[d].end)){b=c[d].size;break}return b},getColorByRange:function(a){for(var b="rgba(50, 50, 255, 1)",c=this.splitList,d=0;d<c.length;d++)if((void 0===c[d].start||void 0!==c[d].start&&a>=c[d].start)&&(void 0===c[d].end||void 0!==c[d].end&&a<c[d].end)){b=c[d].color;break}return b},data_changed:function(){var a=this.get("data");if(a&&a.length>0){this._min=a[0].count,this._max=a[0].count;for(var b=0;b<a.length;b++)this._max=Math.max(this._max,a[b].count),this._min=Math.min(this._min,a[b].count)}},drawType_changed:function(){this.update()},drawOptions_changed:function(){this.update()},update:function(){var a=this.get("drawOptions");a&&a.splitList?this.splitList=a.splitList:this.generalSplitList(),"category"===this.get("layer").getDrawType()&&(a&&a.splitList?this.categorySplitList=a.splitList:this.generalCategorySplitList()),("heatmap"===this.get("layer").getDrawType()||"density"===this.get("layer").getDrawType()||"intensity"===this.get("layer").getDrawType())&&this.generalGradient(a.gradient||this.defaultGradient),this.draw()},draw:function(){this.get("layer").getDataRangeControl()&&this.get("layer").dataRangeControl.show(),"bubble"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawSizeSplit(this.splitList,this.get("drawOptions")):"category"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawCategorySplit(this.categorySplitList,this.get("drawOptions")):"choropleth"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawChoroplethSplit(this.splitList,this.get("drawOptions")):this.get("layer").dataRangeControl.hide()},generalSplitList:function(){var a=Math.ceil((this._max-this._min)/7),b=this._min;this.splitList=[];for(var c=1;b<this._max;)this.splitList.push({start:b,end:b+a,size:c,color:this.colors[c-1]}),b+=a,c++},generalCategorySplitList:function(){var a=["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)"],b=this.get("data");this.categorySplitList={};for(var c=0,d=0;d<b.length&&(void 0===this.categorySplitList[b[d].count]&&(this.categorySplitList[b[d].count]=a[c],c++),!(c>=a.length-1));d++);this.categorySplitList.other=a[a.length-1]},getCategoryColor:function(a){var b=this.categorySplitList,c=b.other;for(var d in b)if(a==d){c=b[d];break}return c},generalGradient:function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=c.createLinearGradient(0,0,0,256);b.width=1,b.height=256;for(var e in a)d.addColorStop(e,a[e]);c.fillStyle=d,c.fillRect(0,0,1,256),this._grad=c.getImageData(0,0,1,256).data},getGradient:function(){return this._grad},getColorByGradient:function(a){var b=this.get("max")||10,c=a/b;c>1&&(c=1),c*=255,c=parseInt(c,10),c*=4;var d="rgba("+this._grad[c]+", "+this._grad[c+1]+", "+this._grad[c+2]+",0.8)";return d}}),util.inherits(SizeDataRange,DataRange),util.extend(SizeDataRange.prototype,{}),util.inherits(Mapv,Class),Mapv.prototype._initDrawScale=function(){this.Scale=new DrawScale},Mapv.prototype.drawTypeControl_changed=function(){this.getDrawTypeControl()?(this.drawTypeControl||(this.drawTypeControl=new DrawTypeControl({mapv:this})),this.getMap().addControl(this.drawTypeControl)):this.drawTypeControl&&this.getMap().removeControl(this.drawTypeControl)},CanvasLayer.prototype=new BMap.Overlay,CanvasLayer.prototype.initialize=function(a){this._map=a;var b=this.canvas=document.createElement("canvas");b.style.cssText="position:absolute;left:0;top:0;z-index:"+this.zIndex+";",this.adjustSize(),a.getPanes()[this.paneName].appendChild(b);var c=this;return a.addEventListener("resize",function(){c.adjustSize(),c.draw()}),this.canvas},CanvasLayer.prototype.adjustSize=function(){var a=this._map.getSize(),b=this.canvas;b.width=a.width,b.height=a.height,b.style.width=b.width+"px",b.style.height=b.height+"px"},CanvasLayer.prototype.draw=function(){var a=this._map,b=a.getBounds(),c=b.getSouthWest(),d=b.getNorthEast(),e=a.pointToOverlayPixel(new BMap.Point(c.lng,d.lat));this.canvas.style.left=e.x+"px",this.canvas.style.top=e.y+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this)},CanvasLayer.prototype.getContainer=function(){return this.canvas},CanvasLayer.prototype.show=function(){this.canvas||this._map.addOverlay(this),this.canvas.style.display="block"},CanvasLayer.prototype.hide=function(){this.canvas.style.display="none"},CanvasLayer.prototype.setZIndex=function(a){this.canvas.style.zIndex=a},CanvasLayer.prototype.getZIndex=function(){return this.zIndex},util.inherits(Layer,Class),util.extend(Layer.prototype,{initialize:function(){if(!this.canvasLayer){this.bindTo("map",this.getMapv()),this.getMap().addControl(this.dataRangeControl);var a=this;this.canvasLayer=new CanvasLayer({map:this.getMap(),zIndex:this.getZIndex(),paneName:this.getPaneName(),update:function(){a.draw()},elementTag:"canvas"}),this.setCtx(this.canvasLayer.getContainer().getContext(this.getContext())),this.getAnimation()&&(this.animationLayer=new CanvasLayer({map:this.getMap(),zIndex:this.getZIndex(),elementTag:"canvas"}),this.setAnimationCtx(this.animationLayer.getContainer().getContext(this.getContext())))}},draw:function(){if(this.getMapv()){var a=this.getCtx();if(!a)return!1;"2d"==this.getContext()&&a.clearRect(0,0,a.canvas.width,a.canvas.height),this._calculatePixel(),this._getDrawer().drawMap(),"polyline"===this.getDataType()&&this.getAnimation()&&!this._animationFlag&&(this.drawAnimation(),this._animationFlag=!0),this.dispatchEvent("draw")}},drawAnimation:function(){var a=this.getAnimationCtx();if(!a)return!1;a.clearRect(0,0,a.canvas.width,a.canvas.height);var b=this;this._getDrawer().drawAnimation(),this.getAnimation()&&requestAnimationFrame(function(){b.drawAnimation()})},animation_changed:function(){this.getAnimation()&&this.drawAnimation()},mapv_changed:function(){return this.getMapv()?(this.canvasLayer&&this.canvasLayer.show(),this.initialize(),this.updateControl(),void this.draw()):void(this.canvasLayer&&this.canvasLayer.hide())},drawType_changed:function(){this.updateControl(),this.draw()},drawOptions_changed:function(){this.draw()},updateControl:function(){var a=this.getMapv();if(a){var b=this._getDrawer();this.getMap();b.scale&&this.getDataRangeControl()?(b.scale(a.Scale),a.Scale.show()):a&&a.Scale.hide(),this.getMapv().OptionalData&&this.getMapv().OptionalData.initController(this,this.getDrawType())}},_getDrawer:function(){var drawType=this.getDrawType();if(!this._drawer[drawType]){var funcName=drawType.replace(/(\w)/,function(a){return a.toUpperCase()});funcName+="Drawer";var drawer=this._drawer[drawType]=eval("(new "+funcName+"(this))");drawer.scale?this.getMapv()&&(drawer.scale(this.getMapv().Scale),this.getMapv().Scale.show()):this.getMapv().Scale.hide()}return this._drawer[drawType]},_calculatePixel:function(){var a=this.getMapv().getMap(),b=a.getMapType().getProjection();console.time("parseData");for(var c=a.getZoom(),d=Math.pow(2,18-c),e=b.lngLatToPoint(a.getCenter()),f=new BMap.Pixel(e.x-a.getSize().width/2*d,e.y+a.getSize().height/2*d),g=this.getData(),a=this.getMap(),h=0;h<g.length;h++){if(g[h].lng&&g[h].lat&&!g[h].x&&!g[h].y){var i=b.lngLatToPoint(new BMap.Point(g[h].lng,g[h].lat));g[h].x=i.x,g[h].y=i.y}if(g[h].x&&g[h].y&&(g[h].px=(g[h].x-f.x)/d,g[h].py=(f.y-g[h].y)/d),g[h].geo){var j=[];if("bd09ll"===this.getCoordType())for(var k=0;k<g[h].geo.length;k++){var i=a.pointToPixel(new BMap.Point(g[h].geo[k][0],g[h].geo[k][1]));j.push([i.x,i.y])}else if("bd09mc"===this.getCoordType())for(var k=0;k<g[h].geo.length;k++)j.push([(g[h].geo[k][0]-f.x)/d,(f.y-g[h].geo[k][1])/d]);g[h].pgeo=j}}console.timeEnd("parseData")},data_changed:function(){var a=this.getData();if(a&&a.length>0){if("polyline"===this.getDataType()&&this.getAnimation())for(var b=0;b<a.length;b++)a[b].index=parseInt(Math.random()*a[b].geo.length,10);this._min=a[0].count,this._max=a[0].count;for(var b=0;b<a.length;b++)this._max=Math.max(this._max,a[b].count),this._min=Math.min(this._min,a[b].count);this.draw()}},getDataRange:function(){return{min:this._min,max:this._max}},zIndex_changed:function(){var a=this.getZIndex();this.canvasLayer.setZIndex(a)},dataRangeControl_changed:function(){this.updateControl(),this._getDrawer().notify("drawOptions")}}),DataControl.prototype.initDom=function(){var a=this.control=document.createElement("div"),b=this.input=document.createElement("input");b.type="file";var c=document.createElement("div");c.textContent="自定义数据：";var d=document.createElement("div");d.textContent="拖拽文件到窗口或者选择自定义文件",a.appendChild(c),a.appendChild(d),a.appendChild(b),a.style.fontSize="12px",a.style.lineHeight="1.8em",a.style.position="absolute",a.style.bottom="50px",a.style.left="10px",a.style.padding="10px 20px",a.style.color="#FFF",a.style.background="rgba(0,0,0,0.5)",a.style.zIndex="100000",a.style.overflow="hidden",a.style.webkitTransition="all 0.5s ease-in";var e=document.createElement("div"),f=document.createElement("div");f.textContent="历史数据",this.history=document.createElement("div"),e.appendChild(f),e.appendChild(this.history),a.appendChild(e),document.body.appendChild(a)},DataControl.prototype.initEvent=function(){function a(a){var c,d=!1;try{c=JSON.parse(a.replace(/\s/g,""));for(var e=0;"string"==typeof c&&10>=e;)c=JSON.parse(c),e++;d=!1}catch(f){d=!0}if(d)try{c=[];var g=a.split("\n");g.length<=1&&(g=a.split("\\n"));for(var h=g[0].split(","),i=1;i<h.length;i++){for(var j=g[i].split(","),k={},l=0,m=0;m<j.length;m++){var n=h[m]||"noname"+l++;n=n.replace(/\\r/g,""),k[n]=Number(j[m].replace(/\\r/g,"").replace(/\"/g,""))}c.push(k)}c=JSON.stringify(c).replace(/\\r/g,""),c=JSON.parse(c),d=!1}catch(f){window.console.log(f),d=!0}if(d)return alert("数据格式错误，请检查是否为json或者csv格式数据"),!1;b.geoData.setData(c),console.log(b["super"]._layers);for(var i=0;i<b["super"]._layers.length;i++)b["super"]._layers[i].draw();return!0}var b=this,c=new FileReader;c.addEventListener("load",function(d){var e=c.result,f=a(e);if(f){var g=localStorage.getItem("filenames")||"{}";if(g=JSON.parse(g),!c.fileName||!c.fileSize)return console.log("no fileName or fileSize , save faild "),!1;for(var h in g)if(g[h].name===this.fileName&&g[h].size===this.fileSize)return!1;var i=this.fileName+this.fileSize+parseInt(1e17*Math.random(),10).toString(36);g[i]={size:this.fileSize,name:this.fileName},localStorage.setItem("filenames",JSON.stringify(g)),localStorage.setItem(i,JSON.stringify(e)),b.initHistory()}}),b.history.addEventListener("click",function(b){var c=b.target;if("A"===c.nodeName){var d=c.getAttribute("storageName"),e=localStorage.getItem(d);a(e)}return!1}),b.input.addEventListener("change",function(a){c.readAsText(a.target.files[0]),c.fileName=a.target.files[0].name,c.fileSize=a.target.files[0].size}),document.addEventListener("dragover",function(a){a.preventDefault()},!1),document.addEventListener("drop",function(a){return a.preventDefault(),c.readAsText(a.dataTransfer.files[0]),c.fileName=a.dataTransfer.files[0].name,c.fileSize=a.dataTransfer.files[0].size,!1})},DataRangeControl.prototype=new BMap.Control,util.extend(DataRangeControl.prototype,{initialize:function(a){var b=this.canvas=document.createElement("canvas");return b.style.background="#fff",b.style.boxShadow="rgba(0,0,0,0.2) 0 0 4px 2px",b.style.border="1px solid #999999",b.style.borderRadius="4px",a.getContainer().appendChild(b),b},getContainer:function(){return this.canvas},drawSizeSplit:function(a,b){var c=this.canvas;c.width=100,c.height=190,c.style.width="100px",c.style.height="190px";for(var d=c.getContext("2d"),e=10,f=0,g=0;g<a.length;g++)a[g].size>f&&(f=a[g].size);for(var g=0;g<a.length;g++){e+=a[g].size,d.beginPath(),d.arc(f+5,e,a[g].size,0,2*Math.PI,!1);var h=a[g].start||"~",i=a[g].end||"~",j=h+" - "+i;d.closePath(),d.fillStyle=b.fillStyle||"rgba(50, 50, 200, 0.8)",d.fill(),d.fillStyle="rgba(30, 30, 30, 1)",d.fillText(j,2*f+10,e+6);var k=a[g].size+5;15>k&&(k=15),e+=k}},drawCategorySplit:function(a,b){var c=this.canvas;c.width=80,c.height=190,c.style.width="80px",c.style.height="190px";var d=c.getContext("2d"),e=0;for(var f in a)d.fillStyle=a[f],d.beginPath(),d.arc(15,25*e+15,5,0,2*Math.PI,!1),d.closePath(),d.fill(),d.fillStyle="#333",d.fillText(f,25,25*e+20),e++},drawChoroplethSplit:function(a,b){var c=this.canvas;c.width=100,c.height=190,c.style.width="100px",c.style.height="190px";var d=c.getContext("2d");d.fillStyle=b.fillStyle||"rgba(50, 50, 200, 0.8)";for(var e=0;e<a.length;e++){d.beginPath(),d.arc(15,25*e+15,5,0,2*Math.PI,!1);var f=(a[e].start||"~")+" - "+(a[e].end||"~");d.closePath(),d.fillStyle=a[e].color,d.fill(),d.fillStyle="#333",d.fillText(f,25,25*e+20)}},hide:function(){this.canvas&&(this.canvas.style.display="none")},show:function(){this.canvas&&(this.canvas.style.display="block")}}),DrawScale.prototype.change=function(a){var b=this;b.changeFn=a},DrawScale.prototype.hide=function(){var a=this;a.box.style.display="none"},DrawScale.prototype.show=function(){var a=this;a.box.style.display="block"},DrawScale.prototype.set=function(a){var b=this;b.max=a.max||b.max,b.min=a.min||b.min,b.colors=a.colors||b.colors,b._draw()},DrawScale.prototype.init=function(){var a=this;a.changeFn=null,a.width=55,a.height=250,a.min=0,a.max=100,a.offsetTop=10,a.offsetBottom=10,a.drawHeight=a.height-a.offsetTop-a.offsetBottom,a.colors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],a.defaultColors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],a.point={x:0,y:0},a.hoveredHandle=null,a.showHandle=!1,a.handleStartPos={val:a.min,yMin:a.offsetTop,yMax:a.offsetTop+a.drawHeight,y:a.offsetTop},a.handleEndPos={val:a.max,yMin:a.offsetTop,yMax:a.offsetTop+a.drawHeight,y:a.offsetTop+a.drawHeight};var b=a.box=document.createElement("div"),c=document.createElement("canvas");c.width=a.width,c.height=a.height,c.style.cursor="pointer",b.style.border="1px solid #999",b.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 0px 4px 2px",b.style.borderRadius="6px",b.style.background="white",b.style.position="absolute",b.style.right="10px",b.style.bottom="10px",b.style.width=a.width+"px",b.style.height=a.height+"px",b.style.zIndex=1e4,b.appendChild(c),document.body.appendChild(b),a.ctx=c.getContext("2d"),a._draw()},DrawScale.prototype._Event=function(){var a=this,b=a.ctx.canvas,c=!1,d={x:0,y:0},e={y:0,name:null};b.addEventListener("mouseenter",function(){a.showHandle=!0,a._draw()}),b.addEventListener("mouseleave",function(){a.showHandle=!1,a._draw()}),b.addEventListener("mousedown",function(b){var f=a.hoveredHandle;if(f){d.x=b.pageX,d.y=b.pageY;var g="handle"+f.name+"Pos";e.name=g,e.y=a[g].y,c=!0}}),window.addEventListener("mousemove",function(b){if(a.point.x=b.offsetX,a.point.y=b.offsetY,c){var f=b.pageY-d.y;a[e.name].y=e.y+f;var g=e.y+f,h=a[e.name].yMax,i=a[e.name].yMin;g=g>h?h:g,g=i>g?i:g,a[e.name].y=g,"handleStartPos"===e.name&&(a.handleEndPos.yMin=g),"handleEndPos"===e.name&&(a.handleStartPos.yMax=g),b.preventDefault()}a._draw()}),window.addEventListener("mouseup",function(b){c&&(a.changeFn&&a.changeFn(a.handleStartPos.val,a.handleEndPos.val),c=!1)})},DrawScale.prototype._draw=function(){var a=this,b=a.ctx;b.clearRect(0,0,b.canvas.width,b.canvas.height),a.hoveredHandle=null;var c,d=5,e=a.offsetTop,f=10,g=a.drawHeight;c="default"===a.colors?a.defaultColors:a.colors;var h=b.createLinearGradient(d,e,f,g),i=g/(c.length-1);if(a.colors instanceof Array||"default"===a.colors)for(var j=0;j<c.length;j++){var k=j*i/a.height;h.addColorStop(k,c[j])}else if("object"==typeof a.colors)for(var j in a.colors)h.addColorStop(j,a.colors[j]);b.fillStyle=b.strokeStyle=h,b.fillRect(d,e,f,g);var l=(a.handleStartPos.y-e)/g*a.max|0,m=a.handleStartPos.val=l+a.min,n=a.handleEndPos.val=(a.handleEndPos.y-e)/g*a.max|0;b.textAlign="left",b.textBaseline="middle";var o=d+f+5;b.fillText("- "+a.min,o,e),b.fillText("- "+a.max,o,e+g),b.save(),b.fillStyle="grey",a.handleStartPos.y>e+10&&b.fillText("- "+m,o,a.handleStartPos.y),a.handleEndPos.y<e+g-10&&b.fillText("- "+n,o,a.handleEndPos.y),b.restore(),a.showHandle&&(drawTips({sup:a,name:"Start",ctx:b,left:d+f,right:b.canvas.width-5,top:a.handleStartPos.y,text:m}),drawTips({sup:a,name:"End",ctx:b,left:d+f,right:b.canvas.width-5,top:a.handleEndPos.y,text:n})),b.save(),b.fillStyle="#ADABAB";var p=d,q=f;b.fillRect(p,e,q,a.handleStartPos.y-a.offsetTop),b.fillRect(p,a.handleEndPos.y,q,g-a.handleEndPos.y+a.offsetTop),b.restore(),a.hoveredHandle?b.canvas.style.cursor="pointer":b.canvas.style.cursor="default"},util.addCssByStyle(["#MapvDrawTypeControl { list-style:none; position:absolute; right:0px; top:0px; bottom:0px; padding:0; margin:0;","border-radius: 5px; overflow: hidden; border: 1px solid rgb(153, 153, 153); box-shadow: rgba(0, 0, 0, 0.2) 0px 0px 4px 2px;}","#MapvDrawTypeControl li{ padding:0; margin:0; cursor:pointer; ","color:#333; padding:5px; background:rgba(255, 255, 255, 1); border-bottom: 1px solid #aaa;}","#MapvDrawTypeControl li.current{ background:#999; color:#fff;}"].join("\n")),util.inherits(DrawTypeControl,Class),util.inherits(DrawTypeControl,BMap.Control),DrawTypeControl.prototype.initialize=function(a){var b=this.ul=document.createElement("ul");b.setAttribute("id","MapvDrawTypeControl");var c=this;return b.addEventListener("click",function(a){var b=a.target;if("LI"===b.nodeName){for(var d=b.parentNode,e=d.getElementsByTagName("li"),f=0;f<e.length;f++)e[f].className="";var g=b.getAttribute("drawType");b.className="current",c.getDrawTypeControlOptions().drawOptions&&c.getDrawTypeControlOptions().drawOptions[g]&&c.layer.setDrawOptions(c.getDrawTypeControlOptions().drawOptions[g]),c.layer.setDrawType(g)}}),this.showLayer(),a.getContainer().appendChild(b),b},DrawTypeControl.prototype.getContainer=function(){return this.ul},DrawTypeControl.prototype.drawTypeControlOptions_changed=function(){this.layer=this.getDrawTypeControlOptions().layer,this.layer&&(this.showLayer(),void 0!==this.getDrawTypeControlOptions().anchor&&this.setAnchor(this.getDrawTypeControlOptions().anchor),void 0!==this.getDrawTypeControlOptions().offset&&this.setOffset(this.getDrawTypeControlOptions().offset))},DrawTypeControl.prototype.showLayer=function(){if(this.layer){var a=this.ul;a.innerHTML="";for(var b=["simple","heatmap","density","bubble","category","choropleth","intensity","cluster"],c=0;c<b.length;c++){var d=b[c],e=document.createElement("li");this.layer.getDrawType()===d&&(e.className="current"),e.setAttribute("drawType",d),e.innerHTML=d,a.appendChild(e)}}},OptionalData.prototype.initCSS=function(){util.addCssByStyle([".controlBox { position:absolute; left:0px; top:0px; background:rgba(0,0,0,0.5); padding:10px; }",".controlBox input {border-radius:6px; border:none; padding:10px;}",".controlBox button ","{ padding:8px 10px; border:none; width:40%; margin-left: 10px; border-radius:6px; cursor:pointer; }",".controlBoxBlock { color:#fff; padding: 10px; }",".controlBoxTitle { display:inline-block; width:100px; text-align:right; padding-right:10px; }"].join("\n"))},OptionalData.prototype.initDom=function(){var a=this.box=document.createElement("div");a.className="controlBox";var b=this.contentBox=document.createElement("div"),c=document.createElement("div");c.style.textAlign="center";var d=this.updateBtn=document.createElement("button"),e=this.resetBtn=document.createElement("button");return d.textContent="update",e.textContent="reset",a.appendChild(b),c.appendChild(d),c.appendChild(e),a.appendChild(c),document.body.appendChild(a),a},OptionalData.prototype.initController=function(a,b){return!1},OptionalData.prototype.bindEvent=function(){var a=this;this.updateBtn.onclick=function(){for(var b=0;b<a.options.editable.length;b++){var c=a.options.editable[b].name,d=a.contentBox.querySelector('input[name="'+c+'"]');d&&("radio"===d.type?(d=a.contentBox.querySelector('input[name="'+c+'"]:checked'),a.options[c]=d.value):"checkbox"===d.type?(d=a.contentBox.querySelector('input[name="'+c+'"]'),a.options[c]=d.checked):"true"===d.getAttribute("isJson")?(console.log(1),a.options[c]=JSON.parse(d.value)):a.options[c]=d.value)}var e=a._layer._getDrawer(a.drawType);e.setDrawOptions(a.options),a._layer.draw()},this.resetBtn.onclick=function(){for(var b=0;b<a.options.editable.length;b++){var c=a.options.editable[b].name,d=a.options.editable[b]._oldVal;a.options[c]=d}var e=this._layer._getDrawer(a.drawType);e.setDrawOptions(a.options),this._layer.draw(),a.initController()}},util.inherits(Drawer,Class),Drawer.prototype.beginDrawMap=function(){"2d"==this.getLayer().getContext()&&this.beginDrawCanvasMap()},Drawer.prototype.endDrawMap=function(){"2d"==this.getLayer().getContext()&&this.endDrawCanvasMap()},Drawer.prototype.beginDrawCanvasMap=function(){var a=this.getDrawOptions(),b=this.getCtx();b.save();for(var c=["globalCompositeOperation","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","fillStyle","strokeStyle","lineWidth","lineCap","lineJoin","lineWidth","miterLimit"],d=0;d<c.length;d++)a[c[d]]&&(b[c[d]]=a[c[d]])},Drawer.prototype.endDrawCanvasMap=function(){var a=this.getCtx();a.restore()},Drawer.prototype.drawOptions_changed=function(){var a=this.getDrawOptions();a&&a.splitList?this.splitList=a.splitList:this.generalSplitList()},Drawer.prototype.colors=["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],Drawer.prototype.generalSplitList=function(){
var a=this.getLayer().getDataRange(),b=Math.ceil((a.max-a.min)/7),c=a.min;this.splitList=[];for(var d=1;c<a.max;)this.splitList.push({start:c,end:c+b,size:d,color:this.colors[d-1]}),c+=b,d++},Drawer.prototype.getRadius=function(){var a=this.getMap().getZoom(),b=Math.pow(2,18-a),c=this.getDrawOptions(),d=c.size||13,e=c.unit||"px";return"m"===e?d/=b:d=d,c.minPxSize&&d<c.minPxSize&&(d=c.minPxSize),d},util.inherits(BubbleDrawer,Drawer),BubbleDrawer.prototype.drawMap=function(){this.beginDrawMap();for(var a=this.getLayer().getData(),b=this.getCtx(),c=this.getDrawOptions(),d=0,e=a.length;e>d;d++){var f=a[d],g=this.dataRange.getSize(f.count);b.beginPath(),b.arc(f.px,f.py,g,0,2*Math.PI,!1),b.closePath(),b.fill(),c.strokeStyle&&b.stroke()}this.endDrawMap()},util.inherits(CategoryDrawer,Drawer),CategoryDrawer.prototype.drawMap=function(){this.beginDrawMap();for(var a=this.getLayer().getData(),b=this.getCtx(),c=this.getDrawOptions(),d=this.getRadius(),e=0,f=a.length;f>e;e++){var g=a[e];b.beginPath(),b.moveTo(g.px,g.py),b.fillStyle=this.dataRange.getCategoryColor(g.count),b.arc(g.px,g.py,d,0,2*Math.PI),b.closePath(),b.fill()}c.strokeStyle&&b.stroke(),this.endDrawMap()},util.inherits(ChoroplethDrawer,Drawer),ChoroplethDrawer.prototype.drawMap=function(){this.beginDrawMap();var a=this.getLayer().getData(),b=this.getLayer().getDataType(),c=this.getCtx(),d=this.getDrawOptions(),e=d.label,f=this.getMap().getZoom();if(e&&e.font&&(c.font=e.font),"polyline"===b||"polygon"===b)for(var g=0,h=a.length;h>g;g++){var i=a[g].pgeo;c.beginPath(),c.moveTo(i[0][0],i[0][1]);for(var j=1;j<i.length;j++)c.lineTo(i[j][0],i[j][1]);if(c.fillStyle=this.dataRange.getColorByRange(a[g].count),(d.strokeStyle||"polyline"===b)&&c.stroke(),"polygon"===b&&(c.closePath(),c.fill()),e&&e.show&&(!e.minZoom||e.minZoom&&f>=e.minZoom)){e.fillStyle&&(c.fillStyle=e.fillStyle);var k=util.getGeoCenter(i);c.fillText(a[g].count,k[0],k[1])}}else{for(var l=this.getRadius(),g=0,h=a.length;h>g;g++){var m=a[g];c.fillStyle=this.dataRange.getColorByRange(m.count),c.beginPath(),c.moveTo(m.px,m.py),c.arc(m.px,m.py,l,0,2*Math.PI),c.closePath(),c.fill()}d.strokeStyle&&c.stroke()}this.endDrawMap()};var min,max;util.inherits(ClusterDrawer,Drawer),ClusterDrawer.prototype.drawMap=function(){this.beginDrawMap(),window.console.time("computerMapData");var a=this.getCtx();max=min=void 0;for(var b=this.getLayer().getData(),c=this.getMapv().getMap(),d=c.getZoom(),e=this.zoomUnit=Math.pow(2,18-d),f=this.formatParam(),g=f.size,h=c.getMapType().getProjection(),i=h.lngLatToPoint(c.getCenter()),j=i.x-c.getSize().width/2*e,k=new BMap.Pixel(j,i.y+c.getSize().height/2*e),l=g/e,m=parseInt(k.x/g,10)*g,n=(m-k.x)/e,o=[],p=0;n+p*l<c.getSize().width;){var q=n+p*l;o.push(q.toFixed(2)),p++}for(var r=parseInt(k.y/g,10)*g+g,s=(k.y-r)/e,t=[],u=0;s+u*l<c.getSize().height;)q=s+u*l,t.push(q.toFixed(2)),u++;for(var v={},w=0;w<o.length;w++)for(var x=0;x<t.length;x++){var y=o[w]+"_"+t[x];v[y]=0}for(var w=0;w<b.length;w++){var z=b[w].px,A=b[w].py,B=parseInt(b[w].count,10),C=z<o[0],D=A<t[0],E=z>Number(o[o.length-1])+Number(l),F=A>Number(t[t.length-1])+Number(l);if(!(C||D||E||F)){for(var x=0;x<o.length;x++){var G=Number(o[x]);if(z>=G&&G+l>z)for(var H=0;H<t.length;H++){var I=Number(t[H]);A>=I&&I+l>A&&(v[o[x]+"_"+t[H]]+=B,B=v[o[x]+"_"+t[H]])}}min=min||B,max=max||B,min=min>B?B:min,max=B>max?B:max}}var J=(max-min+1)/10;window.console.timeEnd("computerMapData"),window.console.time("drawMap");for(var w in v){var K=w.split("_");z=Number(K[0]),A=Number(K[1]);var L=(v[w]-min)/J;L=0>L?0:L;var M=z+l/2,N=A+l/2;a.fillStyle="#fa8b2e",a.beginPath(),a.arc(M,N,5*L,0,2*Math.PI),a.fill(),a.lineWidth=8*L/10,a.strokeStyle="#fff",a.stroke(),a.save(),a.font=30*L/10+"px serif",a.textAlign="center",a.textBaseline="middle",0!==v[w]&&(a.fillStyle="#fff",a.fillText(v[w],M,N),a.restore())}window.console.timeEnd("drawMap"),this.endDrawMap()},ClusterDrawer.prototype.formatParam=function(){var a=this.getDrawOptions(),b=a.size||60;return b+=a.unit||"px",b=/px$/.test(b)?parseInt(b,10)*this.zoomUnit:parseInt(b,10),{size:b}};var min,max;util.inherits(DensityDrawer,Drawer),DensityDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.ctx=b.getCtx(),b.ctx.clearRect(0,0,b.ctx.canvas.width,b.ctx.canvas.height),b.drawMap()}),this.Scale=a},DensityDrawer.prototype.drawMap=function(){this.beginDrawMap();var a=this,b=this.getCtx(),c=this.getLayer().getData(),d=this.getMapv().getMap(),e=d.getZoom(),f=this.zoomUnit=Math.pow(2,18-e),g=formatParam.call(this),h=g.size,i=d.getMapType().getProjection(),j=i.lngLatToPoint(d.getCenter()),k=j.x-d.getSize().width/2*f,l=new BMap.Pixel(k,j.y+d.getSize().height/2*f);window.console.time("computerMapData");var m={data:c,nwMc:l,size:h,zoomUnit:f,ctx:b},n={};n="honeycomb"===this.getDrawOptions().type?honeycombGrid(m):recGrids(m,d),console.log(n);var o=n.grids;this.dataRange.setMax(n.max),this.dataRange.setMin(n.min);var p=n.max,q=n.min;window.console.timeEnd("computerMapData"),window.console.time("drawMap");var m={size:h,zoomUnit:f,max:p,min:q,ctx:b,grids:o,fillColors:g.colors,dataRange:this.dataRange,sup:a},n={};"honeycomb"===this.getDrawOptions().type?drawHoneycomb(m):drawRec(m),window.console.timeEnd("drawMap"),this.Scale&&this.Scale.set({max:p,min:q,colors:this.getDrawOptions().gradient||"default"}),this.endDrawMap()};var r=0;g=0,b=0,util.inherits(HeatmapDrawer,Drawer),HeatmapDrawer.prototype.drawMap=function(){var a=this;a.Scale&&a.Scale.set({min:0,max:a.getMax(),colors:this.getGradient()}),this.beginDrawMap();var b=this.getCtx();this._width=b.canvas.width,this._height=b.canvas.height;var c=this.getLayer().getData();this._data=c,this.drawHeatmap(),this.endDrawMap()},HeatmapDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.drawMap()}),b.Scale=a},util.extend(HeatmapDrawer.prototype,{defaultRadius:10,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},getGradient:function(){return this.getDrawOptions().gradient||this.defaultGradient},getMax:function(){var a=this._max;if(void 0!==this.getDrawOptions().max)a=this.getDrawOptions().max;else{var b=this.getLayer().getDataRange();a=b.min+.7*(b.max-b.min)}return a},data:function(a){return this._data=a,this},max:function(a){return this._max=a,this},add:function(a){return this._data.push(a),this},clear:function(){return this._data=[],this},radius:function(a){if(void 0!==this.getDrawOptions().shadowBlur)var b=this.getDrawOptions().shadowBlur;else var b=15;var c=this._circle=document.createElement("canvas"),d=c.getContext("2d"),e=this._r=a+b;"rect"===this.getDrawOptions().type?c.width=c.height=e:c.width=c.height=2*e;var f=1e4;return d.shadowOffsetX=d.shadowOffsetY=f,d.shadowBlur=b,d.shadowColor="black",d.beginPath(),"rect"===this.getDrawOptions().type?d.fillRect(-f,-f,c.width,c.height):d.arc(e-f,e-f,a,0,2*Math.PI,!0),d.closePath(),d.fill(),this},drawHeatmap:function(a){this.radius(this.getRadius());var b=this.getCtx();b.save(),b.clearRect(0,0,this._width,this._height);var c=this.getLayer().getDataType();if("polyline"===c){b.strokeStyle=this.getDrawOptions().strokeStyle||"rgba(0, 0, 0, 0.05)",b.lineWidth=this.getDrawOptions().lineWidth||1;for(var d=0,e=this._data.length;e>d;d++){h=this._data[d];var f=h.pgeo;b.moveTo(f[0][0],f[0][1]);for(var g=1;g<f.length;g++)b.lineTo(f[g][0],f[g][1])}b.stroke()}else for(var h,i=this.getDrawOptions().boundary||50,d=0,e=this._data.length;e>d;d++)h=this._data[d],h.px<-i||h.py<-i||h.px>b.canvas.width+i||h.py>b.canvas.height+i||(b.globalAlpha=Math.max(h.count/this.getMax(),void 0===a?.05:a),b.drawImage(this._circle,h.px-this._r,h.py-this._r));var j=b.getImageData(0,0,this._width,this._height);return this.colorize(j.data,this.dataRange.getGradient()),b.putImageData(j,0,0),b.restore(),this},colorize:function(a,b){var c=0,d=1024;this.masker.min&&(c=this.masker.min/this.getMax()*1024),this.masker.max&&(d=this.masker.max/this.getMax()*1024);for(var e,f=3,g=a.length;g>f;f+=4){e=4*a[f];var h=this.getDrawOptions().maxOpacity||.8;a[f]/256>h&&(a[f]=256*h),e&&e>=c&&d>=e?(a[f-3]=b[e],a[f-2]=b[e+1],a[f-1]=b[e+2]):a[f]=0}}}),util.inherits(IntensityDrawer,Drawer),IntensityDrawer.prototype.defaultGradient={"0.0":"yellow","1.0":"red"},IntensityDrawer.prototype.drawMap=function(){this.beginDrawMap();var a=this,b=this.getCtx(),c=this.getLayer().getData(),d=this.getDrawOptions();b.strokeStyle=d.strokeStyle;var e=b.canvas.width,f=b.canvas.height;window.console.time("drawMap");var g=this.getRadius(),h=this.getLayer().getDataType(),i=d.label,j=this.getMap().getZoom();if(i&&i.font&&(b.font=i.font),"polygon"===h)for(var k=0,l=c.length;l>k;k++){var m=c[k].pgeo;b.beginPath(),b.moveTo(m[0][0],m[0][1]),b.fillStyle=this.dataRange.getColorByGradient(c[k].count);for(var n=1;n<m.length;n++)b.lineTo(m[n][0],m[n][1]);if(b.closePath(),b.fill(),i&&i.show&&(!i.minZoom||i.minZoom&&j>=i.minZoom)){i.fillStyle&&(b.fillStyle=i.fillStyle);var o=util.getGeoCenter(m);b.fillText(c[k].count,o[0],o[1])}}else for(var k=0,l=c.length;l>k;k++){var p=c[k];if(!(p.px<0||p.px>e||p.py<0||p.py>f)){var q=a.masker.min&&p.count<a.masker.min,r=a.masker.max&&p.count>a.masker.max;q||r||(b.beginPath(),b.moveTo(p.px,p.py),b.fillStyle=this.dataRange.getColorByGradient(p.count),b.arc(p.px,p.py,g||1,0,2*Math.PI),b.closePath(),b.fill())}}window.console.timeEnd("drawMap"),d.strokeStyle&&b.stroke(),this.Scale&&this.Scale.set({min:0,max:a.getMax(),colors:this.getGradient()}),this.dataRange.setMax(a.getMax()),this.endDrawMap()},IntensityDrawer.prototype.getGradient=function(){return this.getDrawOptions().gradient||this.defaultGradient},IntensityDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.drawMap()}),b.Scale=a},IntensityDrawer.prototype.getMax=function(){var a=this.getLayer().getDataRange(),b=a.max;return this.getDrawOptions().max&&(b=this.getDrawOptions().max),b},util.inherits(SimpleDrawer,Drawer),SimpleDrawer.prototype.drawMap=function(){if("webgl"===this.getLayer().getContext())return void this.drawWebglMap();this.beginDrawMap();var a=this.getLayer().getData(),b=this.getCtx(),c=this.getDrawOptions();console.log("????",c),b.beginPath(),c.globalCompositeOperation&&(b.globalCompositeOperation=c.globalCompositeOperation);var d=this.getRadius(),e=this.getLayer().getDataType();if("polyline"===e||"polygon"===e)for(var f=0,g=a.length;g>f;f++){var h=a[f].pgeo;b.beginPath(),b.moveTo(h[0][0],h[0][1]);for(var i=1;i<h.length;i++)b.lineTo(h[i][0],h[i][1]);(c.strokeStyle||"polyline"===e)&&b.stroke(),"polygon"===e&&(b.closePath(),b.fill())}else if(c.strokeStyle||c.globalCompositeOperation)for(var f=0,g=a.length;g>f;f++){var j=a[f];j.px<0||j.px>b.canvas.width||j.py<0||j>b.canvas.height||(b.beginPath(),b.moveTo(j.px,j.py),b.arc(j.px,j.py,d,0,2*Math.PI,!1),b.fill(),b.stroke())}else{for(var f=0,g=a.length;g>f;f++){var j=a[f];j.px<0||j.px>b.canvas.width||j.py<0||j>b.canvas.height||(b.moveTo(j.px,j.py),b.arc(j.px,j.py,d,0,2*Math.PI,!1))}b.fill()}this.endDrawMap()},SimpleDrawer.prototype.drawAnimation=function(){var a=this.getLayer().getData(),b=this.getLayer().getDataType(),c=this.getLayer().getAnimationOptions(),d=this.getLayer().getAnimationCtx();if("polyline"===b)for(var e=0,f=a.length;f>e;e++){var g=a[e].index,h=a[e].pgeo,i=h[g][0],j=h[g][1],k=d.createRadialGradient(i,j,0,i,j,c.size);k.addColorStop(0,"rgba(255, 255, 255, 1)"),k.addColorStop(.4,"rgba(255, 255, 255, 0.9)"),k.addColorStop(1,"rgba(255, 255, 255, 0)"),d.fillStyle=k,d.beginPath(),d.arc(i,j,c.size,0,2*Math.PI,!1),d.closePath(),d.fill(),a[e].index++,a[e].index>=a[e].pgeo.length&&(a[e].index=0)}},SimpleDrawer.prototype.drawWebglMap=function(){var a=this.getLayer().getData();if(a){var b,c,d,e,f=this.getCtx();b=f.createShader(f.VERTEX_SHADER),c=f.createShader(f.FRAGMENT_SHADER),d=["attribute vec4 a_Position;","attribute float a_PointSize;","void main() {","gl_Position = a_Position;","gl_PointSize = a_PointSize;","}"].join(""),e=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var g=f.createProgram();f.shaderSource(b,d),f.compileShader(b),f.shaderSource(c,e),f.compileShader(c),f.attachShader(g,b),f.attachShader(g,c),f.linkProgram(g),f.useProgram(g);var h=f.getAttribLocation(g,"a_Position"),i=f.getAttribLocation(g,"a_PointSize"),j=f.getUniformLocation(g,"u_FragColor");f.clear(f.COLOR_BUFFER_BIT);for(var k=f.canvas.width/2,l=f.canvas.height/2,m=[],n=0,o=0;o<a.length;o++){var p=a[o],q=(p.px-k)/k,r=(l-p.py)/l;-1>q||q>1||-1>r||r>1||(m.push(q,r),n++)}var s=new Float32Array(m),t=n,u=f.createBuffer();if(!u)return console.log("Failed to create the buffer object"),-1;f.bindBuffer(f.ARRAY_BUFFER,u),f.bufferData(f.ARRAY_BUFFER,s,f.STATIC_DRAW);var h=f.getAttribLocation(g,"a_Position");if(0>h)return console.log("Failed to get the storage location of a_Position"),-1;f.vertexAttribPointer(h,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(h),f.vertexAttrib1f(i,this.getRadius()),console.log(this.getRadius());var v=document.createElement("canvas"),w=v.getContext("2d");v.width=1,v.height=1,w.fillStyle=this.getDrawOptions().fillStyle,w.fillRect(0,0,1,1);var x=w.getImageData(0,0,1,1).data;f.uniform4f(j,x[0]/255,x[1]/255,x[2]/255,x[3]/255),f.drawArrays(f.POINTS,0,t)}},Mapv.Layer=Layer,this.Mapv=Mapv}();